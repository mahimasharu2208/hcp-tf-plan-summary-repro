name: apply

on:
  workflow_run:
    workflows: ["plan"]
    types:
      - completed

permissions:
  actions: read
  contents: read

jobs:
  run-apply:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download plan summary artifact from plan run
        uses: actions/download-artifact@v4
        with:
          name: plan-summary
          run-id: ${{ github.event.workflow_run.id }}

      - name: Fetch Latest Run ID from TFC
        id: fetch_run
        run: |
          RUN_ID=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            "https://app.terraform.io/api/v2/workspaces/${{ secrets.TFC_WORKSPACE_ID }}/runs" \
            | jq -r '.data[0].id')

          echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Latest run: $RUN_ID"

      - name: Trigger Apply
        id: do_apply
        run: |
          RUN_ID=${{ steps.fetch_run.outputs.run-id }}

          echo "Applying run $RUN_ID"

          curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data '{"data":{"type":"run-actions","attributes":{"action":"apply"}}}' \
            https://app.terraform.io/api/v2/runs/$RUN_ID/actions/apply \
            > apply_trigger.json

          cat apply_trigger.json

      - name: Wait for Apply to Finish
        run: |
          RUN_ID=${{ steps.fetch_run.outputs.run-id }}

          echo "Waiting for apply to complete..."
          for i in {1..40}; do
            STATUS=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
              https://app.terraform.io/api/v2/runs/$RUN_ID \
              | jq -r '.data.attributes.status')

            echo "Current status: $STATUS"

            if [[ "$STATUS" == "applied" ]]; then
              break
            fi

            if [[ "$STATUS" == "errored" ]]; then
              echo "Apply failed!"
              exit 1
            fi

            sleep 10
          done

      - name: Fetch Apply Summary
        run: |
          RUN_ID=${{ steps.fetch_run.outputs.run-id }}

          APPLY_ID=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            https://app.terraform.io/api/v2/runs/$RUN_ID \
            | jq -r '.data.relationships.apply.data.id')

          curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            https://app.terraform.io/api/v2/applies/$APPLY_ID \
            | jq '.data.attributes' > apply_summary.json

          echo "Apply summary:"
          cat apply_summary.json

      - name: Upload apply summary
        uses: actions/upload-artifact@v4
        with:
          name: apply-summary
          path: apply_summary.json
