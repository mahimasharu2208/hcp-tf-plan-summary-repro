name: plan

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  run-plan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Run in HCP Terraform
        id: create_run
        run: |
          RUN_PAYLOAD=$(cat <<EOF
          {
            "data": {
              "type": "runs",
              "attributes": {
                "message": "Triggered via GitHub Actions",
                "is-destroy": false
              },
              "relationships": {
                "workspace": {
                  "data": {
                    "type": "workspaces",
                    "id": "${{ secrets.TFC_WORKSPACE_ID }}"
                  }
                }
              }
            }
          }
          EOF
          )

          echo "Creating run..."
          RESPONSE=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data "$RUN_PAYLOAD" \
            https://app.terraform.io/api/v2/runs)

          echo "$RESPONSE" > run.json

          RUN_ID=$(jq -r '.data.id' run.json)
          echo "run-id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Triggered Run ID: $RUN_ID"

      - name: Wait for Plan to Finish
        id: wait_plan
        run: |
          RUN_ID=${{ steps.create_run.outputs.run-id }}

          echo "Waiting for plan to complete..."
          for i in {1..40}; do
            STATUS=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
              https://app.terraform.io/api/v2/runs/$RUN_ID | jq -r '.data.attributes.status')

            echo "Current status: $STATUS"

            if [[ "$STATUS" == "planned" || "$STATUS" == "planned_and_finished" ]]; then
              break
            fi

            if [[ "$STATUS" == "errored" ]]; then
              echo "Plan failed!"
              exit 1
            fi

            sleep 10
          done

      - name: Fetch Plan Summary
        id: plan_summary
        run: |
          RUN_ID=${{ steps.create_run.outputs.run-id }}

          PLAN_ID=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            https://app.terraform.io/api/v2/runs/$RUN_ID \
            | jq -r '.data.relationships.plan.data.id')

          echo "Plan ID: $PLAN_ID"

          curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            https://app.terraform.io/api/v2/plans/$PLAN_ID \
            | jq '.data.attributes' > plan_summary.json

          echo "Plan summary:"
          cat plan_summary.json

      - name: Upload summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: plan-summary
          path: plan_summary.json
