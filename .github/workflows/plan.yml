name: Terraform Plan (TFC API)

on:
  push:
    branches:
      - main
    paths:
      - "**.tf"
      - ".github/workflows/plan.yml"
      
permissions:
  actions: read
  contents: read
  
jobs:
  plan:
    runs-on: ubuntu-latest
      
    steps: # Correctly indented 4 spaces under 'plan:'
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Create Plan
        id: create_plan
        run: |
          echo "Creating run..."

          RUN_RESPONSE=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            --data "{
              \"data\": {
                \"attributes\": {
                  \"message\": \"GitHub Actions Plan\",
                  \"plan-only\": true
                },
                \"type\": \"runs\",
                \"relationships\": {
                  \"workspace\": {
                    \"data\": {
                      \"type\": \"workspaces\",
                      \"name\": \"${{ secrets.TFC_WORKSPACE }}\",
                      \"organization\": \"${{ secrets.TFC_ORG }}\"
                    }
                  }
                }
              }
            }" \
            https://app.terraform.io/api/v2/runs)

          RUN_ID=$(echo "$RUN_RESPONSE" | jq -r '.data.id')
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Run ID: $RUN_ID"

      - name: Wait for Plan Completion
        id: wait_plan
        run: |
          RUN_ID="${{ steps.create_plan.outputs.run_id }}"

          echo "Waiting for plan to finish..."

          STATUS="pending"
          while [ "$STATUS" != "planned" ] && [ "$STATUS" != "errored" ] && [ "$STATUS" != "canceled" ]; do
            sleep 5
            STATUS=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
              https://app.terraform.io/api/v2/runs/$RUN_ID |
              jq -r '.data.attributes.status')
            echo "Current Status: $STATUS"
          done

          echo "final_status=$STATUS" >> $GITHUB_OUTPUT

      - name: Fetch Plan JSON Output
        if: steps.wait_plan.outputs.final_status == 'planned'
        run: |
          RUN_ID="${{ steps.create_plan.outputs.run_id }}"

          PLAN_ID=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            https://app.terraform.io/api/v2/runs/$RUN_ID |
            jq -r '.data.relationships.plan.data.id')

          echo "Plan ID: $PLAN_ID"

          curl -s \
            --header "Authorization: Bearer ${{ secrets.TFC_TOKEN }}" \
            https://app.terraform.io/api/v2/plans/$PLAN_ID/json-output \
            -o plan.json

      - name: Upload Plan Output
        uses: actions/upload-artifact@v4
        with:
          name: plan-json
          path: plan.json

      - name: Trigger Apply Workflow
        if: steps.wait_plan.outputs.final_status == 'planned'
        uses: peter-evans/workflow-dispatch@v1
        with:
          workflow: apply.yml
